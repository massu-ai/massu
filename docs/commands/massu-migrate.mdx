---
title: "/massu-migrate"
description: "Database migration creation, validation, and RLS verification"
order: 11
---

# /massu-migrate

Creates database migrations, validates schema changes, and verifies RLS policies for Supabase projects.

## Usage

```
/massu-migrate [mode]
```

## Modes

### create
Creates a new database migration with automatic RLS and type generation.

**Steps:**
1. **Analyze Schema Change**: User describes desired schema change
2. **Generate SQL**: Creates migration file in `supabase/migrations/` with timestamp
3. **Verify RLS**: Ensures all tables have RLS policies (SELECT, INSERT, UPDATE, DELETE)
4. **Check Indexes**: Suggests indexes for foreign keys and frequently queried columns
5. **Validate Triggers**: Adds `updated_at` triggers if timestamp columns present
6. **Sync Types**: Reminds to run `npx supabase gen types typescript` after applying migration

**Output:**
- Migration SQL file: `supabase/migrations/[timestamp]_[description].sql`
- Rollback SQL (auto-generated): `supabase/migrations/[timestamp]_[description]_rollback.sql`

### validate
Validates existing migrations for completeness and correctness.

**Checks:**
- All tables have RLS enabled
- RLS policies exist for all CRUD operations
- Foreign key constraints have indexes
- Triggers are properly defined
- Migration is idempotent (safe to re-run)
- No breaking changes without migration strategy

**Output:**
- List of validation warnings/errors
- Suggested fixes for each issue

### check
Quick health check of migration status.

**Checks:**
- Counts pending migrations (in `supabase/migrations/` but not applied)
- Verifies migration order (no timestamp conflicts)
- Checks for manual schema changes (drift detection)
- Validates migration file naming conventions

**Output:**
- Migration status summary
- Next steps if issues found

## RLS Policy Generation

For each new table, generates standard RLS policies:

```sql
-- Enable RLS
ALTER TABLE [table_name] ENABLE ROW LEVEL SECURITY;

-- SELECT: Users can read their own data
CREATE POLICY "Users can read own [table_name]"
  ON [table_name] FOR SELECT
  USING (auth.uid() = user_id);

-- INSERT: Users can insert their own data
CREATE POLICY "Users can insert own [table_name]"
  ON [table_name] FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- UPDATE: Users can update their own data
CREATE POLICY "Users can update own [table_name]"
  ON [table_name] FOR UPDATE
  USING (auth.uid() = user_id);

-- DELETE: Users can delete their own data
CREATE POLICY "Users can delete own [table_name]"
  ON [table_name] FOR DELETE
  USING (auth.uid() = user_id);
```

Customizes policies based on table purpose (public lookup tables, admin-only, etc.).

## Rollback SQL Generation

Auto-generates rollback SQL for:
- `CREATE TABLE` → `DROP TABLE`
- `ALTER TABLE ADD COLUMN` → `ALTER TABLE DROP COLUMN`
- `CREATE INDEX` → `DROP INDEX`
- `CREATE POLICY` → `DROP POLICY`

Rollback file saved alongside migration for easy reversion.

## When to Use

- **Adding new database tables**: Use `/massu-migrate create` to generate migration with RLS
- **Modifying schema**: Adding/removing columns, indexes, constraints
- **Checking migration health**: Use `/massu-migrate check` to verify migration status
- **Before deployment**: Use `/massu-migrate validate` to ensure all migrations are production-ready
- **Vs manual SQL**: `/massu-migrate` enforces RLS best practices and generates rollbacks automatically
